name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  CARGO_TERM_COLOR: always

jobs:
  validate:
    name: Validate node structure
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Check node.yaml exists for all nodes
        run: |
          expected="inference network-monitor openmeteo rtsp-camera system-telemetry"
          for node in $expected; do
            if [ ! -f "$node/node.yaml" ]; then
              echo "ERROR: $node/node.yaml missing"
              exit 1
            fi
            echo "OK: $node/node.yaml"
          done

      - name: Validate nodes.yaml registry
        run: |
          if [ ! -f "nodes.yaml" ]; then
            echo "ERROR: nodes.yaml missing"
            exit 1
          fi
          # Check that all 5 nodes are listed
          for node in rtsp-camera openmeteo inference system-telemetry network-monitor; do
            if ! grep -q "name: $node" nodes.yaml; then
              echo "ERROR: $node not found in nodes.yaml"
              exit 1
            fi
            echo "OK: $node in nodes.yaml"
          done

  rust-nodes:
    name: "Build ${{ matrix.node }}"
    runs-on: ubuntu-latest
    needs: validate
    strategy:
      fail-fast: false
      matrix:
        node:
          - rtsp-camera
          - openmeteo
          - inference
          - system-telemetry
    steps:
      - uses: actions/checkout@v4

      - uses: prefix-dev/setup-pixi@v0.8.1
        with:
          manifest-path: ${{ matrix.node }}/pixi.toml
          cache: true

      - uses: Swatinem/rust-cache@v2
        with:
          workspaces: "${{ matrix.node }} -> target"

      - name: Build
        working-directory: ${{ matrix.node }}
        run: pixi run build

      - name: Clippy
        working-directory: ${{ matrix.node }}
        run: cargo clippy --all-targets -- -D warnings

  python-nodes:
    name: "Build network-monitor"
    runs-on: ubuntu-latest
    needs: validate
    steps:
      - uses: actions/checkout@v4

      - uses: prefix-dev/setup-pixi@v0.8.1
        with:
          manifest-path: network-monitor/pixi.toml
          cache: true

      - name: Install dependencies
        working-directory: network-monitor
        run: pixi install

      - name: Build protos
        working-directory: network-monitor
        run: pixi run build-proto
        continue-on-error: true
